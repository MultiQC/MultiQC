name: "Generate module docs"
on:
  pull_request:
    paths:
      - "multiqc/modules/**"
      - "pyproject.toml"

jobs:
  gen_module_docs:
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.event.head_commit.message, '[automated]') }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.MQC_BOT_GITHUB_TOKEN }}

      # Action runs on the issue comment, so we don't get the PR by default.
      # Use the GitHub CLI to check out the PR:
      - name: "Checkout Pull Request"
        env:
          GITHUB_TOKEN: ${{ secrets.MQC_BOT_GITHUB_TOKEN }}
        run: gh pr checkout ${{ github.event.pull_request.number }}

      - uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: "Install MultiQC"
        run: pip install -e '.[dev]'

      - name: "Download test data"
        uses: actions/checkout@v4
        with:
          repository: MultiQC/test-data
          path: test-data

      - name: "Generate docs"
        run: python .github/workflows/gen_module_docs.py

      - name: "Commit and push changes"
        run: |
          git config user.name 'MultiQC Bot'
          git config user.email 'multiqc-bot@seqera.io'
          git config push.default upstream
          git add docs/autogenerated
          pre-commit run prettier --all-files || true
          git add docs/autogenerated
          git status
          # commit if there are changes
          if [[ -n $(git status -s) ]]; then
            git commit -m "[automated] Autogenerate module docs"
            git push
          fi

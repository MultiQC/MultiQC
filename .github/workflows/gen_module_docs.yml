name: "Generate module docs"
on:
  pull_request:
    paths:
      - "multiqc/modules/**"
      - "pyproject.toml"

jobs:
  gen_module_docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.MQC_BOT_GITHUB_TOKEN }}

      # Action runs on the issue comment, so we don't get the PR by default.
      # Use the GitHub CLI to check out the PR:
      - name: "Checkout Pull Request"
        env:
          GITHUB_TOKEN: ${{ secrets.MQC_BOT_GITHUB_TOKEN }}
        run: gh pr checkout ${{ github.event.pull_request.number }}

      - uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: "Install MultiQC"
        run: pip install -e '.[dev]'

      - name: "Download test data"
        uses: actions/checkout@v4
        with:
          repository: MultiQC/test-data
          path: test-data

      - name: "Generate docs"
        run: python .github/workflows/gen_module_docs.py

      - name: "Check if any files changed"
        run: |
          git diff --exit-code || echo "changed=YES" >> $GITHUB_ENV
          echo "Files changed: ${{ env.changed }}"

      - name: "Commit and push changes"
        if: env.changed == 'YES'
        run: |
          git config user.name 'MultiQC Bot'
          git config user.email 'multiqc-bot@seqera.io'
          git config push.default upstream
          git add docs/autogenerated
          git status
          git commit -m "[automated] Autogenerate module docs"
          git push

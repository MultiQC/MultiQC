"""
Generate docs/modules/<module.md> files for each module in MultiQC from the MultiqcModule class docstrings.

Usage:

    python scripts/make_module_docs.py
    python scripts/make_module_docs.py samtools
"""

import os
from typing import Dict

import yaml

import argparse
from pathlib import Path
from textwrap import dedent, indent

from multiqc import config, report, BaseMultiqcModule

parser = argparse.ArgumentParser(description=__doc__)
parser.add_argument("module", help="Generate for a specific module", nargs="?")
args = parser.parse_args()

sp_by_mod: Dict[str, Dict] = dict()
with (Path(config.MODULE_DIR) / "search_patterns.yaml").open() as f:
    for k, v in yaml.safe_load(f).items():
        mod_id = k.split("/")[0]
        sp_by_mod.setdefault(mod_id, {})[k] = v


os.makedirs("docs/autogenerated", exist_ok=True)


for mod_id, entry_point in config.avail_modules.items():
    if args.module and args.module != mod_id:
        continue
    if mod_id == "custom_content":
        continue

    mod_data_dir = Path("test-data") / "data" / "modules" / mod_id
    assert mod_data_dir.exists() and mod_data_dir.is_dir(), mod_data_dir
    report.analysis_files = [mod_data_dir]
    report.search_files([mod_id])

    module_cls = entry_point.load()
    docstring = module_cls.__doc__ or ""

    module: BaseMultiqcModule = module_cls()

    if module.extra:
        extra = "\n".join(line.strip() for line in module.extra.split("\n") if line.strip())
        extra += "\n\n"
    else:
        extra = ""

    text = f"""\
---
name: {module.name}
urls: {module.href}
summary: >
  {module.info}
---

<!--
~~~~~ DO NOT EDIT ~~~~~
This file is autogenerated from the MultiQC module python docstring.
Do not edit the markdown, it will be overwritten.

File path for the source of this content: multiqc/modules/{mod_id}/{mod_id}.py
~~~~~~~~~~~~~~~~~~~~~~~
-->

{extra}{dedent(docstring)}

### File search patterns

```yaml
{yaml.dump(sp_by_mod[mod_id]).strip()}
```
""".strip()

    # Remove double empty lines
    while "\n\n\n" in text:
        text = text.replace("\n\n\n", "\n\n")

    output_path = Path("docs") / "autogenerated" / f"{mod_id}.md"
    with output_path.open("w") as fh:
        fh.write(text)

    print(f"Generated {output_path}")
